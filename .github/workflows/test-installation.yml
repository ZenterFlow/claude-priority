name: Test Plugin Installation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  test-marketplace:
    name: Test Marketplace Installation
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify marketplace structure
        run: |
          echo "ğŸ” Checking marketplace structure..."

          # Check marketplace.json exists
          if [ ! -f ".claude-plugin/marketplace.json" ]; then
            echo "âŒ marketplace.json not found"
            exit 1
          fi
          echo "âœ… marketplace.json found"

          # Check each plugin directory exists
          for plugin in plugin-formatter claude-prioritise; do
            if [ ! -d "$plugin" ]; then
              echo "âŒ Plugin directory not found: $plugin"
              exit 1
            fi
            echo "âœ… Plugin directory found: $plugin"
          done
        shell: bash

      - name: Verify plugin.json files
        run: |
          echo "ğŸ” Checking plugin.json files..."

          for plugin in plugin-formatter claude-prioritise; do
            if [ ! -f "$plugin/.claude-plugin/plugin.json" ]; then
              echo "âŒ plugin.json not found in: $plugin"
              exit 1
            fi
            echo "âœ… plugin.json found in: $plugin"
          done
        shell: bash

      - name: Check for required skills
        run: |
          echo "ğŸ” Checking skills directories..."

          # plugin-formatter should have plugin-formatter skill
          if [ ! -d "plugin-formatter/skills/plugin-formatter" ]; then
            echo "âŒ plugin-formatter skill not found"
            exit 1
          fi
          echo "âœ… plugin-formatter skill found"

          # claude-prioritise should have project-status skill
          if [ ! -d "claude-prioritise/skills/project-status" ]; then
            echo "âŒ project-status skill not found"
            exit 1
          fi
          echo "âœ… project-status skill found"
        shell: bash

      - name: Installation test summary
        if: success()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Marketplace structure validated on ${{ matrix.os }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Ready for installation:"
          echo "  /plugin marketplace add $(pwd)"
          echo "  /plugin install plugin-formatter@claude-priority"
          echo "  /plugin install claude-prioritise@claude-priority"
        shell: bash
